{"componentChunkName":"component---src-templates-blog-post-js","path":"/useRef/","result":{"data":{"site":{"siteMetadata":{"title":"Overblog","author":"zit"}},"markdownRemark":{"id":"f4a2657a-2cf9-5611-ac41-e72d20019963","html":"<h2 id=\"refs-介绍\"><a href=\"#refs-%E4%BB%8B%E7%BB%8D\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>refs 介绍</h2>\n<p>在 React 数据流中，props 是父组件和子组件交互的唯一方式。要修改一个子组件，必须使用新的 props 去重新渲染它。而 refs 提供了另一种方式，允许我们在 React 典型数据流之外，去操作 DOM 元素和类组件的实例。  </p>\n<h3 id=\"dom、类组件和-ref\"><a href=\"#dom%E3%80%81%E7%B1%BB%E7%BB%84%E4%BB%B6%E5%92%8C-ref\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DOM、类组件和 ref</h3>\n<p>React 中有两个创建 ref 的方法，createRef() 和 useRef()。使用 ref，只需要将它们创建的 ref 赋到 DOM 和类组件的 ref 属性上即可。当组件挂载之后，ref 的 current 属性访问的就是对该节点的引用，DOM 元素时就是该元素，类组件时就是该组件的实例。</p>\n<h3 id=\"函数组件和-ref\"><a href=\"#%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E5%92%8C-ref\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>函数组件和 ref</h3>\n<p>函数组件不支持 ref 属性，因为它没有实例，有时候可以使用下面介绍的 ref 转发来做一些操作，比如将 ref 传递给函数组件的某个 DOM。除了 ref 转发之外，也可以在函数组件的 props 中添加一个特殊的 prop ，接收父组件的 ref，再赋值到具体的 DOM 上。  </p>\n<p>这两种做法都是将子组件的某些掌控权交给父组件。</p>\n<h2 id=\"回调-refs\"><a href=\"#%E5%9B%9E%E8%B0%83-refs\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>回调 refs</h2>\n<p>这是 react 中另外一个使用 ref 的方式。<br>\n在 DOM 或者类组件的 ref 属性上，传递一个函数。React 会将当前的元素的引用作为此函数的参数，便于进行后面的操作。  </p>\n<p>需要注意的是，回调函数传入的值可能会是 null，在回调函数中需要针对 null 的情况做处理，避免出现问题。为什么会有 null 呢？如果 ref 回调函数是以内联函数的方式定义的，在更新过程中它会被执行两次，第一次传入参数 null，然后第二次会传入参数 DOM 元素。这是因为在每次渲染时会创建一个新的函数实例，所以 React 清空旧的 ref 并且设置新的。  </p>\n<p>这里其实有个疑问，ref 应该没有新旧之分，清空旧的应该是针对回调函数中的引用的 props 和 state。我测试了一下，在回调函数中打印 state 的值，第一次传入参数 null 时，回调函数中引用的 state 还是更新之前的值，第二次传入 DOM 元素时，回调函数中的 state 已经是最新值，所以猜测是 React 想清除回调函数在上一次执行环境中的影响。</p>\n<h2 id=\"ref-转发\"><a href=\"#ref-%E8%BD%AC%E5%8F%91\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ref 转发</h2>\n<p>refs 转发是将 ref 向下传递，允许某些组件接收 ref，比如函数组件。函数组件本身没有 ref 属性，但是可以通过转发，将子组件 DOM 的控制权暴露给父组件。  </p>\n<p>值得注意的是，forwardRef 接受渲染函数作为参数，普通函数和 class 组件无法使用 ref 转发。将普通函数传入 forwardRef 时，第二个参数 ref 不存在；将 class 组件传入 forwardRef 时会出错，因为 class 组件不是函数类型。</p>\n<p>在高阶组件（HOC）中使用 ref 时，需要避免 ref 不向下传递的问题。高阶组件会将所有的 props 向下传递，但是 ref 是单独的一个属性，和 key 类似，不向下传递，所以当你希望可以获取到被包裹的组件实例，而将一个 ref 挂到高阶组件上时，获取到的并不是相应的组件。<br>\n这时候可以通过 ref 转发，在高阶组件中获取到 ref，再将 ref 通过特殊的 prop 名字向下传递。<a href=\"https://zh-hans.reactjs.org/docs/forwarding-refs.html#forwarding-refs-in-higher-order-components\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">参考</a></p>\n<h2 id=\"ref-的几种用法\"><a href=\"#ref-%E7%9A%84%E5%87%A0%E7%A7%8D%E7%94%A8%E6%B3%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ref 的几种用法</h2>\n<ul>\n<li>\n<p>类似实例变量，存储某些值<br>\n除了在 ref 属性上使用之外，ref 可以保存一个可变的值，类似 class 中的实例字段。它会确保在每次更新渲染中返回的是同一个 ref 对象。这给函数式组件提供了一种在更新之外使用可变变量的方式。</p>\n<blockquote>\n<p>Unless you’re doing lazy initialization, avoid setting refs during rendering — this can lead to surprising behavior. Instead, typically you want to modify refs in event handlers and effects.<br>\nReact 不建议在渲染过程中修改 ref，也没说原因，估计是底层相关部分没那么坚固，尽量避免吧，在函数或者 effect 中修改。</p>\n</blockquote>\n</li>\n<li>获取上一轮的 props 或 state<br>\n在 useEffect 中将值保存在 ref.current，下次更新时取到的就是上一轮的数据</li>\n<li>使用回调 ref 连接 DOM<br>\nuseRef 和 createRef 不会把值的变化通知到我们，回调 ref 可以做到这一点，在变化时会执行传入的函数。不要忘了处理 null 的情况</li>\n<li>\n<p>引用函数组件<br>\n我们可以使用 ref 直接引用 class 组件，那么可以引用函数组件吗？也可以，但是和 class 组件方式不一样，我们使用 useImperativeHandle hook 结合 ref 转发，自定义向父组件暴露的方法。  </p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// 子组件</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token punctuation\">,</span> ref</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onChange</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> inputRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">useImperativeHandle</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">focus</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      inputRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    onChange<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>inputRef<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>onChange<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">forwardRef</span><span class=\"token punctuation\">(</span>Form<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 父组件</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Form</span></span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>ref<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这样在父组件的 ref.current 上，就有了两个方法：focus 和 onChange</p>\n</li>\n</ul>\n<p>好了，以上便是 ref 的相关内容，基本涵盖了常用的内容，没事回来看看，常看常新～</p>","timeToRead":4,"frontmatter":{"title":"useRef 的全部","date":"August 18, 2021","spoiler":"一文搞懂 useRef","cta":"react"},"fields":{"slug":"/useRef/","langKey":"en"}}},"pageContext":{"slug":"/useRef/","previous":{"fields":{"slug":"/useEffect/","langKey":"en","directoryName":"useEffect"},"frontmatter":{"title":"useEffect 的全部"}},"next":{"fields":{"slug":"/useContext/","langKey":"en","directoryName":"useContext"},"frontmatter":{"title":"useContext 的全部"}},"translations":[],"translatedLinks":[]}},"staticQueryHashes":["708209134"]}